name: Project automations
on:
  issues:
    types:
      - opened
      - reopened
      - closed
  pull_request:
    types:
      - opened
      - reopened
      - review_requested
      - converted_to_draft
      - ready_for_review
      - review_request_removed
      - closed
  push:
    branches:
      - "**/[0-9]**"

env:
  in_progress: üèó In progress
  in_review: üëÄ In review
  done: ‚úÖ Done

jobs:
  branch_push:
    name: branch_push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Get issue node ID from branch
        id: get_issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const issue_number = parseInt(branch.split('-')[0]);
            if (isNaN(issue_number)) {
              core.setOutput('node_id', '');
              return;
            }
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
            });
            core.setOutput('node_id', issue.data.node_id);
      - name: Move Issue to In Progress
        if: steps.get_issue.outputs.node_id != ''
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_AUTOMATION }}
          organization: appliedagi
          project_id: 5
          resource_node_id: ${{ steps.get_issue.outputs.node_id }}
          status_value: ${{ env.in_progress }}

  get_issue_node_id:
    name: Get linked issue node ID
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      issue_node_id: ${{ steps.get_issue.outputs.node_id }}
    steps:
      - name: Get issue node ID from branch
        id: get_issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION }}
          script: |
            const branch = context.payload.pull_request.head.ref;
            const issue_number = parseInt(branch.split('-')[0]);
            if (isNaN(issue_number)) {
              core.setOutput('node_id', '');
              return;
            }
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
            });
            core.setOutput('node_id', issue.data.node_id);

  pr_opened:
    name: pr_opened
    runs-on: ubuntu-latest
    needs: get_issue_node_id
    if: github.event_name == 'pull_request' && github.event.action == 'opened' && needs.get_issue_node_id.outputs.issue_node_id != ''
    steps:
      - name: Move Issue to ${{ env.in_progress }}
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_AUTOMATION }}
          organization: appliedagi
          project_id: 5
          resource_node_id: ${{ needs.get_issue_node_id.outputs.issue_node_id }}
          status_value: ${{ env.in_progress }}

  pr_in_draft:
    name: pr_opened_in_draft
    runs-on: ubuntu-latest
    needs: get_issue_node_id
    if: github.event_name == 'pull_request' && github.event.action == 'converted_to_draft' && needs.get_issue_node_id.outputs.issue_node_id != ''
    steps:
      - name: Move Issue to ${{ env.in_progress }}
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_AUTOMATION }}
          organization: appliedagi
          project_id: 5
          resource_node_id: ${{ needs.get_issue_node_id.outputs.issue_node_id }}
          status_value: ${{ env.in_progress }}

  pr_in_review:
    name: pr_in_review
    runs-on: ubuntu-latest
    needs: get_issue_node_id
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft && !github.event.pull_request.merged && github.event.action != 'closed' && needs.get_issue_node_id.outputs.issue_node_id != ''
    steps:
      - name: Move Issue to ${{ env.in_review }}
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_AUTOMATION }}
          organization: appliedagi
          project_id: 5
          resource_node_id: ${{ needs.get_issue_node_id.outputs.issue_node_id }}
          status_value: ${{ env.in_review }}

  pr_merged:
    name: pr_merged
    runs-on: ubuntu-latest
    needs: get_issue_node_id
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged && needs.get_issue_node_id.outputs.issue_node_id != ''
    steps:
      - name: Move Issue to ${{ env.done }}
        uses: leonsteinhaeuser/project-beta-automations@v2.1.0
        with:
          gh_token: ${{ secrets.PROJECT_AUTOMATION }}
          organization: appliedagi
          project_id: 5
          resource_node_id: ${{ needs.get_issue_node_id.outputs.issue_node_id }}
          status_value: ${{ env.done }}
